<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">

<dom-module id="foaas-element">
  <template>
    <style>
      :host {
        display: inline;
      }
    </style>
    <iron-ajax id="foaas_load" handle-as="json" headers='{"Accept": "application/json"}'>
    </iron-ajax>
    <div>
      <div id="foaas_content"></div>
      <div id="foaas_signature"></div>
    </div>
  </template>

  <script>
    /**
     * `foaas-element`
     * This component will help you add the contents provided by www.foaas.com
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FoaasElement extends Polymer.Element {
      static get is() { return 'foaas-element'; }
      static get properties() {
        return {
          loading: {
            type: Boolean,
            value: false,
            notify: true,
            ReadOnly: true,
            reflectToAttribute: true
          },
          type: {
            type: String,
            observer:'_typeChanged'
          },
          from: String,
          company: String,
          name: String,
          tool: String,
          something: String,
          reference: String,
          noun: String,
          reaction: String,
          behaviour: String,
          thing: String
        };
      }

      static get URL() { return "http://www.foaas.com/"; }

      connectedCallback() {
        super.connectedCallback();
        this._loadFoaas();
      }

      _typeChanged(newValue, oldValue) {
        if (oldValue !== undefined) {
          this._loadFoaas();
        }
      }

      _loadFoaas() {
        this.loading = true;
        if (this._type_descriptions === undefined) {
          // First time : we have to load the list of operations 
          this._loadTypeDescriptions()
            .then(this._processDescriptions.bind(this))
            .then(this._loadQuote.bind(this))
            .then(this._processResponseQuote.bind(this))
            .catch(this._processError.bind(this));
        }
        else {
          this._loadQuote()
            .then(this._processResponseQuote.bind(this))
            .catch(this._processError.bind(this));
        }
      }

      _loadQuote() {
        let ajax = this.$.foaas_load;
        ajax.url = this._generateUrl();
        let self = this;
        return ajax.generateRequest().completes;
      }

      _processResponseQuote(response) {
        let foaas_response = response.__data.response;
        this.$.foaas_content.textContent = foaas_response.message;
        this.$.foaas_signature.textContent = foaas_response.subtitle;
        this.loading = false;
      }

      _processError(error) {
        this.$.foaas_content.textContent = "oups, there was a problem with you giving a fuck";
        this.loading = false;
      }

      _generateUrl() {
        let url = FoaasElement.URL;
        // First we add the type
        url += this.type + "/";
        // Then the parameters
        // We are using the fact that the properties of the component have 
        // the same name than the parameters in the description
        url += this._type_descriptions[this.type].map(elem => this[elem]).join("/");
        return url;
      }

      _loadTypeDescriptions() {
        let ajax = this.$.foaas_load;
        ajax.url = FoaasElement.URL + "operations";
        let self = this;
        return ajax.generateRequest().completes;
      }

      _processDescriptions(response) {
        this._type_descriptions = {};
        let foaas_response = response.__data.response;
        for (let elem of foaas_response) { // forEach doesn't work here. wtf ?
          let tab_api = elem.url.split('/');
          // The second item of the url is the type (because the url begins with "/")
          // Then comes the list of parameters. Every parameter begins with a ':'
          tab_api.shift();
          let type = tab_api.shift();
          this._type_descriptions[type] = tab_api.map(elem => elem.substring(1));
        }
        return Promise.resolve();
      }
    }

    window.customElements.define(FoaasElement.is, FoaasElement);
  </script>
</dom-module>